@if (isLoading()) {
  <div class="flex items-center justify-center min-h-[60vh]">
    <div class="flex flex-col items-center gap-4">
      <div class="w-12 h-12 border-4 border-crimson-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-zinc-400">Loading track...</p>
    </div>
  </div>
} @else if (track()) {
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <a
      routerLink="/library"
      class="inline-flex items-center gap-2 text-zinc-400 hover:text-white transition-colors mb-8 group"
    >
      <ng-icon
        name="lucideArrowLeft"
        size="20"
        class="group-hover:-translate-x-1 transition-transform"
      ></ng-icon>
      Back to Library
    </a>

    <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl overflow-hidden">
      <div class="relative h-48 sm:h-64 bg-linear-to-br from-crimson-900/50 to-zinc-900">
        @if (coverUrl()) {
          <img
            [src]="coverUrl()"
            alt="Cover"
            class="absolute inset-0 w-full h-full object-cover opacity-30 blur-xl"
          />
        }
        <div class="absolute inset-0 bg-linear-to-t from-zinc-900 to-transparent"></div>

        <div class="absolute bottom-0 left-0 right-0 p-6 sm:p-8">
          <div class="flex flex-col sm:flex-row items-start sm:items-end gap-6">
            <div class="w-32 h-32 sm:w-40 sm:h-40 rounded-xl overflow-hidden bg-zinc-800 shadow-2xl shrink-0 border border-zinc-700/50">
              @if (coverUrl()) {
                <img [src]="coverUrl()" alt="Cover" class="w-full h-full object-cover" />
              } @else {
                <div class="w-full h-full flex items-center justify-center bg-linear-to-br from-crimson-600/30 to-zinc-900">
                  <ng-icon name="lucideMusic" size="48" class="text-crimson-500/70"></ng-icon>
                </div>
              }
            </div>

            <div class="flex-1 min-w-0">
              <span class="inline-block px-3 py-1 text-xs font-semibold text-crimson-400 bg-crimson-500/10 rounded-full uppercase tracking-wider mb-2">
                {{ categoryLabel }}
              </span>
              <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white truncate mb-2">
                {{ track()!.title }}
              </h1>
              <p class="text-xl text-zinc-300 flex items-center gap-2">
                <ng-icon name="lucideUser" size="18" class="text-zinc-500"></ng-icon>
                {{ track()!.artist }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="p-6 sm:p-8">
        <div class="flex flex-wrap items-center gap-3 mb-8">
          <button
            class="flex items-center gap-3 px-8 py-4 bg-crimson-600 hover:bg-crimson-500 text-white font-semibold rounded-full transition-all shadow-lg shadow-crimson-500/25 hover:shadow-crimson-500/40 hover:scale-105"
            (click)="togglePlay()"
          >
            <ng-icon [name]="isPlaying ? 'lucidePause' : 'lucidePlay'" size="24"></ng-icon>
            {{ isPlaying ? 'Pause' : 'Play Now' }}
          </button>

          @if (!isInQueue) {
            <button
              class="flex items-center gap-2 px-5 py-3 bg-zinc-800 hover:bg-zinc-700 text-white font-medium rounded-full transition-colors"
              (click)="addToQueue()"
            >
              <ng-icon name="lucideListPlus" size="18"></ng-icon>
              Add to Queue
            </button>
          } @else {
            <span class="flex items-center gap-2 px-5 py-3 bg-crimson-500/20 text-crimson-400 font-medium rounded-full">
              <ng-icon name="lucideListPlus" size="18"></ng-icon>
              In Queue
            </span>
          }

          <button
            class="flex items-center gap-2 px-5 py-3 bg-zinc-800 hover:bg-zinc-700 text-white font-medium rounded-full transition-colors"
            (click)="openEditModal()"
          >
            <ng-icon name="lucidePencil" size="18"></ng-icon>
            Edit
          </button>

          <button
            class="flex items-center gap-2 px-5 py-3 bg-zinc-800 hover:bg-red-600 text-zinc-400 hover:text-white font-medium rounded-full transition-colors"
            (click)="openDeleteConfirm()"
          >
            <ng-icon name="lucideTrash2" size="18"></ng-icon>
            Delete
          </button>
        </div>

        @if (track()!.description) {
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-zinc-500 uppercase tracking-wider mb-2">Description</h3>
            <p class="text-zinc-300 leading-relaxed">{{ track()!.description }}</p>
          </div>
        }

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          <div class="p-4 bg-zinc-800/50 rounded-xl border border-zinc-700/50">
            <div class="flex items-center gap-2 text-zinc-500 mb-1">
              <ng-icon name="lucideClock" size="16"></ng-icon>
              <span class="text-xs uppercase tracking-wider">Duration</span>
            </div>
            <p class="text-lg font-semibold text-white">{{ track()!.duration | duration }}</p>
          </div>

          <div class="p-4 bg-zinc-800/50 rounded-xl border border-zinc-700/50">
            <div class="flex items-center gap-2 text-zinc-500 mb-1">
              <ng-icon name="lucideDisc" size="16"></ng-icon>
              <span class="text-xs uppercase tracking-wider">Category</span>
            </div>
            <p class="text-lg font-semibold text-white">{{ categoryLabel }}</p>
          </div>

          <div class="p-4 bg-zinc-800/50 rounded-xl border border-zinc-700/50">
            <div class="flex items-center gap-2 text-zinc-500 mb-1">
              <ng-icon name="lucideCalendar" size="16"></ng-icon>
              <span class="text-xs uppercase tracking-wider">Added</span>
            </div>
            <p class="text-lg font-semibold text-white">{{ track()!.createdAt | date: 'MMM d, y' }}</p>
          </div>

          <div class="p-4 bg-zinc-800/50 rounded-xl border border-zinc-700/50">
            <div class="flex items-center gap-2 text-zinc-500 mb-1">
              <ng-icon name="lucideFileAudio" size="16"></ng-icon>
              <span class="text-xs uppercase tracking-wider">Format</span>
            </div>
            <p class="text-lg font-semibold text-white">Audio</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  @if (showEditModal()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4"
      (click)="closeEditModal()"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()"
      >
        <div class="flex items-center justify-between p-4 border-b border-zinc-800">
          <h2 class="text-xl font-semibold text-white">Edit Track</h2>
          <button
            class="p-1.5 rounded-lg hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors"
            (click)="closeEditModal()"
          >
            <ng-icon name="lucideX" size="20"></ng-icon>
          </button>
        </div>
        <div class="p-4">
          <app-track-form
            [track]="track()"
            [isLoading]="isSubmitting()"
            (submitted)="onUpdateTrack($event)"
            (cancelled)="closeEditModal()"
          ></app-track-form>
        </div>
      </div>
    </div>
  }

  @if (showDeleteConfirm()) {
    <app-confirm-dialog
      title="Delete Track"
      [message]="'Are you sure you want to delete \'' + track()!.title + '\'? This action cannot be undone.'"
      confirmText="Delete"
      [isDestructive]="true"
      (confirmed)="onDeleteTrack()"
      (cancelled)="closeDeleteConfirm()"
    ></app-confirm-dialog>
  }
}
